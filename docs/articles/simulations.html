<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulations • streamMetabolizer</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Simulations">
<meta property="og:description" content="streamMetabolizer">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">streamMetabolizer</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.12.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data_prep.html">Data Preparation</a>
    </li>
    <li>
      <a href="../articles/get_started.html">Quickstart</a>
    </li>
    <li>
      <a href="../articles/gpp_er_eqs.html">GPP and ER Equations</a>
    </li>
    <li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/model_structures.html">Model Structures</a>
    </li>
    <li>
      <a href="../articles/models_bayes.html">Bayesian Models</a>
    </li>
    <li>
      <a href="../articles/models_mle.html">MLE Models</a>
    </li>
    <li>
      <a href="../articles/ode_methods.html">ODE Methods</a>
    </li>
    <li>
      <a href="../articles/simulations.html">Simulations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USGS-R/streamMetabolizer/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="simulations_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Simulations</h1>
                        <h4 class="author">Alison Appling</h4>
            
            <h4 class="date">2021-07-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/USGS-R/streamMetabolizer/blob/master/vignettes/simulations.Rmd"><code>vignettes/simulations.Rmd</code></a></small>
      <div class="hidden name"><code>simulations.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>This vignette shows how to simulate dissolved oxygen ‘observations’ for the purpose of exploring and testing metabolism models.</p>
</div>
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<p>Load streamMetabolizer and some helper packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/USGS-R/streamMetabolizer">streamMetabolizer</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
<p>Get some data to work with: here we’re requesting three days of data at 15-minute resolution. Thanks to Bob Hall for the test data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_metab.html">data_metab</a></span><span class="op">(</span><span class="st">'3'</span>, <span class="st">'15'</span><span class="op">)</span></code></pre></div>
</div>
<div id="creating-a-sim-model" class="section level1">
<h1 class="hasAnchor">
<a href="#creating-a-sim-model" class="anchor"></a>Creating a Sim Model</h1>
<p>To create a simulation model, you should</p>
<ol style="list-style-type: decimal">
<li>Choose a model structure</li>
<li>Choose daily metabolism parameters</li>
<li>Choose the other model specifications</li>
<li>Create the model</li>
<li>Generate predictions (simulations) from the model</li>
</ol>
<div id="choosing-the-model-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#choosing-the-model-structure" class="anchor"></a>1. Choosing the model structure</h2>
<p>You can simulate data using any of the GPP and ER functions available to MLE models. Simulations are done by models of type <code>'sim'</code> but otherwise take very similar arguments to those of an MLE model. Here we’ll use a model where ER is a function of temperature.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">name_sim_q10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mm_name.html">mm_name</a></span><span class="op">(</span><span class="st">'sim'</span>, ER_fun<span class="op">=</span><span class="st">'q10temp'</span><span class="op">)</span></code></pre></div>
</div>
<div id="choosing-the-daily-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#choosing-the-daily-parameters" class="anchor"></a>2. Choosing the daily parameters</h2>
<p>To simulate data, you need to specify the daily parameters beforehand. The model structure determines which parameters are needed. There are three good ways to learn which daily parameters you need to specify.</p>
<div id="a--trial-and-error" class="section level3">
<h3 class="hasAnchor">
<a href="#a--trial-and-error" class="anchor"></a>A. Trial and error</h3>
<p>To learn about parameter needs by trial and error, simply create the model with the equations you want but without daily inputs, ask for the parameters, and read the error message to get a list of parameters. It’s fine to use the defaults for the specifications for now.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mm_sim_q10_trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="va">name_sim_q10</span><span class="op">)</span>, <span class="va">dat</span><span class="op">)</span>
<span class="fu"><a href="../reference/get_params.html">get_params</a></span><span class="op">(</span><span class="va">mm_sim_q10_trial</span><span class="op">)</span></code></pre></div>
<pre><code>##         date K600.daily GPP.daily        ER20 err.obs.sigma err.obs.phi err.proc.sigma err.proc.phi
## 1 2012-09-18   6.470136  9.884494 -12.7664324          0.01           0            0.2            0
## 2 2012-09-19   1.751171 13.870601  -0.9501805          0.01           0            0.2            0
## 3 2012-09-20   1.292966 14.209754 -19.4489723          0.01           0            0.2            0
##   discharge.daily
## 1        21.79474
## 2        18.22975
## 3        19.76588</code></pre>
<p>Great: we need <code>GPP.daily</code>, <code>ER20</code>, and <code>K600.daily</code>. Now we can pick values for those parameters and put them in a data.frame.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_sim_q10a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>date<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'2012-09-'</span>,<span class="fl">18</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span>, GPP.daily<span class="op">=</span><span class="fl">2.1</span>, ER20<span class="op">=</span><span class="op">-</span><span class="fl">5</span><span class="op">:</span><span class="op">-</span><span class="fl">3</span>, K600.daily<span class="op">=</span><span class="fl">16</span><span class="op">)</span>
<span class="va">params_sim_q10a</span></code></pre></div>
<pre><code>##         date GPP.daily ER20 K600.daily
## 1 2012-09-18       2.1   -5         16
## 2 2012-09-19       2.1   -4         16
## 3 2012-09-20       2.1   -3         16</code></pre>
</div>
<div id="b--generate-parameters-from-another-model" class="section level3">
<h3 class="hasAnchor">
<a href="#b--generate-parameters-from-another-model" class="anchor"></a>B. Generate parameters from another model</h3>
<p>You can also use fitted parameters from another model as your input for a simulation model. This method could be useful for identifying realistic parameters and/or exploring why a model fitting process didn’t work so well.</p>
<p>First fit an MLE model to the same data using the <code>GPP_fun</code> and <code>ER_fun</code> you want. It’s fine (again) to use the defaults for the specifications.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mm_mle_q10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="fu"><a href="../reference/mm_name.html">mm_name</a></span><span class="op">(</span><span class="st">'mle'</span>, ER_fun<span class="op">=</span><span class="st">'q10temp'</span><span class="op">)</span><span class="op">)</span>, data<span class="op">=</span><span class="va">dat</span><span class="op">)</span></code></pre></div>
<p>Then ask for the parameters in the right format (without columns for uncertainty or messages).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_sim_q10b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_params.html">get_params</a></span><span class="op">(</span><span class="va">mm_mle_q10</span>, uncertainty<span class="op">=</span><span class="st">'none'</span>, messages<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="va">params_sim_q10b</span></code></pre></div>
<pre><code>##         date GPP.daily      ER20 K600.daily
## 1 2012-09-18  2.051333 -2.696135   22.36965
## 2 2012-09-19  2.436224 -3.147503   24.27164
## 3 2012-09-20  2.090918 -2.370546   22.84253</code></pre>
</div>
<div id="c--look-at-mm_name" class="section level3">
<h3 class="hasAnchor">
<a href="#c--look-at-mm_name" class="anchor"></a>C. Look at <code>?mm_name</code>
</h3>
<p>Try it. We put lots of details in the help file. Check out the documentation for the <code>GPP_fun</code> and <code>ER_fun</code> args in particular.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">?</span><span class="va">mm_name</span></code></pre></div>
<p>After reading the documentation you’ll create a data.frame of the same format as in options A or B.</p>
</div>
</div>
<div id="choosing-the-specifications" class="section level2">
<h2 class="hasAnchor">
<a href="#choosing-the-specifications" class="anchor"></a>3. Choosing the specifications</h2>
<p>After choosing parameters, the next step is to choose the rest of the specifications. The main difference between sim models and other models is that you can choose values for the probability distributions of the observation and/or process errors. See <code><a href="../reference/specs.html">?specs</a></code> for details on the distribution parameters <code>err_obs_sigma</code>, <code>err_obs_phi</code>, <code>err_proc_sigma</code>, and <code>err_proc_phi</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">specs_sim_q10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="va">name_sim_q10</span>, err_obs_sigma<span class="op">=</span><span class="fl">0</span>, err_proc_sigma<span class="op">=</span><span class="fl">1</span>, K600_daily<span class="op">=</span><span class="cn">NULL</span>, GPP_daily<span class="op">=</span><span class="cn">NULL</span>, ER20<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>
<span class="va">specs_sim_q10</span></code></pre></div>
<pre><code>## Model specifications:
##   model_name        s_np_oipcpi_tr_plrqkm.rnorm                                      
##   day_start         4                                                                
##   day_end           28                                                               
##   day_tests         full_day, even_timesteps, complete_data, pos_discharge, pos_depth
##   required_timestep NA                                                               
##   discharge_daily   function; see element [['discharge_daily']] for details          
##   DO_mod_1          NULL                                                             
##   K600_daily        NULL                                                             
##   GPP_daily         NULL                                                             
##   ER20              NULL                                                             
##   err_obs_sigma     0                                                                
##   err_obs_phi       0                                                                
##   err_proc_sigma    1                                                                
##   err_proc_phi      0                                                                
##   err_round         NA                                                               
##   sim_seed          NA</code></pre>
</div>
<div id="creating-a-model" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-a-model" class="anchor"></a>4. Creating a model</h2>
<p>Now you can create a simulation model much as you would an MLE or Bayesian model. We’ll make two models here, one for each of the parameter sets we created above.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mm_sim_q10a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="va">specs_sim_q10</span>, <span class="va">dat</span>, data_daily<span class="op">=</span><span class="va">params_sim_q10a</span><span class="op">)</span>
<span class="va">mm_sim_q10b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="va">specs_sim_q10</span>, <span class="va">dat</span>, data_daily<span class="op">=</span><span class="va">params_sim_q10b</span><span class="op">)</span></code></pre></div>
</div>
<div id="generating-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#generating-predictions" class="anchor"></a>5. Generating predictions</h2>
<p>Predictions and simulations are one and the same when your model is of type <code>sim</code>. The output of <code>predict_DO</code> for <code>sim</code> models includes three DO concentration columns. <code>DO.pure</code> is what the DO concentrations would be if the GPP, ER, and K600 parameters exactly described what occurred in the stream. If there’s process error in your model, <code>DO.mod</code> will differ from <code>DO.pure</code> in that <code>DO.mod</code> also contains the process error as a fourth driver (on top of GPP, ER, and reaeration) of in-situ DO concentrations. (<code>DO.mod</code> and <code>DO.pure</code> are identical if there’s no process error.) Lastly, <code>DO.obs</code> is a simulation of what your sensor might record; it includes everything in <code>DO.mod</code> plus observation error representing inaccuracies in how the sensor reads or records the DO concentration. These three variables are plotted as a muted-color line (<code>DO.pure</code>), a bold dark line (<code>DO.mod</code>), and brightly colored points (<code>DO.obs</code>). <code>DO.pure</code> is mostly hidden behind the others unless the errors are large.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/predict_DO.html">predict_DO</a></span><span class="op">(</span><span class="va">mm_sim_q10a</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##         date          solar.time   DO.sat depth temp.water light  DO.pure   DO.mod   DO.obs
## 1 2012-09-18 2012-09-18 04:05:58 9.083329  0.16       3.60     0 8.410000 8.410000 8.410000
## 2 2012-09-18 2012-09-18 04:20:58 9.093063  0.16       3.56     0 8.333532 8.298641 8.298641
## 3 2012-09-18 2012-09-18 04:35:58 9.105254  0.16       3.51     0 8.266667 8.229109 8.229109
## 4 2012-09-18 2012-09-18 04:50:58 9.112582  0.16       3.48     0 8.208204 8.151041 8.151041
## 5 2012-09-18 2012-09-18 05:05:58 9.127267  0.16       3.42     0 8.157374 8.032420 8.032420
## 6 2012-09-18 2012-09-18 05:20:58 9.137079  0.16       3.38     0 8.113493 7.981263 7.981263</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/predict_DO.html">predict_DO</a></span><span class="op">(</span><span class="va">mm_sim_q10b</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##         date          solar.time   DO.sat depth temp.water light  DO.pure   DO.mod   DO.obs
## 1 2012-09-18 2012-09-18 04:05:58 9.083329  0.16       3.60     0 8.410000 8.410000 8.410000
## 2 2012-09-18 2012-09-18 04:20:58 9.093063  0.16       3.56     0 8.431047 8.368797 8.368797
## 3 2012-09-18 2012-09-18 04:35:58 9.105254  0.16       3.51     0 8.450642 8.371374 8.371374
## 4 2012-09-18 2012-09-18 04:50:58 9.112582  0.16       3.48     0 8.468822 8.407282 8.407282
## 5 2012-09-18 2012-09-18 05:05:58 9.127267  0.16       3.42     0 8.485984 8.426545 8.426545
## 6 2012-09-18 2012-09-18 05:20:58 9.137079  0.16       3.38     0 8.502466 8.494334 8.494334</code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_DO_preds.html">plot_DO_preds</a></span><span class="op">(</span><span class="va">mm_sim_q10a</span>, y_var<span class="op">=</span><span class="st">'conc'</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_DO_preds.html">plot_DO_preds</a></span><span class="op">(</span><span class="va">mm_sim_q10b</span>, y_var<span class="op">=</span><span class="st">'conc'</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
</div>
</div>
<div id="simulating-errors" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-errors" class="anchor"></a>Simulating Errors</h1>
<p>The main purpose of simulation models is to generate DO ‘observations’ with error, i.e., noise, to see whether other models can recover the underlying parameters despite the noise.</p>
<p>For this section we’ll use a simulation with GPP as a saturating function of light. We’ll use method B from above to choose our daily parameters.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">specs_sim_sat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="fu"><a href="../reference/mm_name.html">mm_name</a></span><span class="op">(</span><span class="st">'sim'</span>, GPP_fun<span class="op">=</span><span class="st">'satlight'</span><span class="op">)</span>, err_obs_sigma<span class="op">=</span><span class="fl">0</span>, err_proc_sigma<span class="op">=</span><span class="fl">1</span>, K600_daily<span class="op">=</span><span class="cn">NULL</span>, Pmax<span class="op">=</span><span class="cn">NULL</span>, alpha<span class="op">=</span><span class="cn">NULL</span>, ER_daily<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>
<span class="va">params_sim_sat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_params.html">get_params</a></span><span class="op">(</span><span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="fu"><a href="../reference/mm_name.html">mm_name</a></span><span class="op">(</span><span class="st">'mle'</span>, GPP_fun<span class="op">=</span><span class="st">'satlight'</span><span class="op">)</span><span class="op">)</span>, data<span class="op">=</span><span class="va">dat</span><span class="op">)</span>, uncertainty<span class="op">=</span><span class="st">'none'</span>, messages<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div id="innovative-errors" class="section level2">
<h2 class="hasAnchor">
<a href="#innovative-errors" class="anchor"></a>Innovative errors</h2>
<p>By default, simulations generate new noise each time you request predictions.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mm_sim_sat_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="va">specs_sim_sat</span>, <span class="va">dat</span>, data_daily<span class="op">=</span><span class="va">params_sim_sat</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot_DO_preds.html">plot_DO_preds</a></span><span class="op">(</span><span class="va">mm_sim_sat_i</span>, y_var<span class="op">=</span><span class="st">'conc'</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_DO_preds.html">plot_DO_preds</a></span><span class="op">(</span><span class="va">mm_sim_sat_i</span>, y_var<span class="op">=</span><span class="st">'conc'</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
</div>
<div id="fixed-errors" class="section level2">
<h2 class="hasAnchor">
<a href="#fixed-errors" class="anchor"></a>Fixed errors</h2>
<p>Alternatively, you can revise the value of <code>sim_seed</code> to be a number (any number) and then the simulation produces the same noise each time.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mm_sim_sat_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="fu"><a href="../reference/revise.html">revise</a></span><span class="op">(</span><span class="va">specs_sim_sat</span>, sim_seed<span class="op">=</span><span class="fl">47</span><span class="op">)</span>, <span class="va">dat</span>, data_daily<span class="op">=</span><span class="va">params_sim_sat</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot_DO_preds.html">plot_DO_preds</a></span><span class="op">(</span><span class="va">mm_sim_sat_f</span>, y_var<span class="op">=</span><span class="st">'conc'</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_DO_preds.html">plot_DO_preds</a></span><span class="op">(</span><span class="va">mm_sim_sat_f</span>, y_var<span class="op">=</span><span class="st">'conc'</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-14-2.png" width="700"></p>
</div>
</div>
<div id="inspecting-models" class="section level1">
<h1 class="hasAnchor">
<a href="#inspecting-models" class="anchor"></a>Inspecting Models</h1>
<p>We’ll use a slightly longer dataset here to demonstrate the potential for random noise at the levels of both the observations (every time you run <code><a href="../reference/predict_DO.html">predict_DO()</a></code>) and the daily parameters (every time you define <code>data_daily</code>).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_metab.html">data_metab</a></span><span class="op">(</span><span class="st">'10'</span>, <span class="st">'30'</span><span class="op">)</span>
<span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>date<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'2012-09-'</span>,<span class="fl">18</span><span class="op">:</span><span class="fl">27</span><span class="op">)</span><span class="op">)</span>, Pmax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">6</span>, <span class="fl">2</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">0.01</span>, <span class="fl">0.001</span><span class="op">)</span>, ER20<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span>, K600.daily<span class="op">=</span><span class="fl">16</span><span class="op">)</span>
<span class="va">specs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="fu"><a href="../reference/mm_name.html">mm_name</a></span><span class="op">(</span><span class="st">'sim'</span>, GPP_fun<span class="op">=</span><span class="st">'satlight'</span>, ER_fun<span class="op">=</span><span class="st">'q10temp'</span><span class="op">)</span>, err_obs_sigma<span class="op">=</span><span class="fl">0.2</span>, err_proc_sigma<span class="op">=</span><span class="fl">1</span>, K600_daily<span class="op">=</span><span class="cn">NULL</span>, Pmax<span class="op">=</span><span class="cn">NULL</span>, alpha<span class="op">=</span><span class="cn">NULL</span>, ER20<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>
<span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="va">specs</span>, data<span class="op">=</span><span class="va">dat</span>, data_daily<span class="op">=</span><span class="va">params</span><span class="op">)</span></code></pre></div>
<p>Sim models print out their parameters with asterisks to denote that the values are fixed rather than fitted.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mm</span></code></pre></div>
<pre><code>## metab_model of type metab_sim 
## streamMetabolizer version 0.12.0 
## Specifications:
##   model_name        s_np_oipcpi_tr_psrqkm.rnorm                                      
##   day_start         4                                                                
##   day_end           28                                                               
##   day_tests         full_day, even_timesteps, complete_data, pos_discharge, pos_depth
##   required_timestep NA                                                               
##   discharge_daily   function; see element [['discharge_daily']] for details          
##   DO_mod_1          NULL                                                             
##   K600_daily        NULL                                                             
##   Pmax              NULL                                                             
##   alpha             NULL                                                             
##   ER20              NULL                                                             
##   err_obs_sigma     0.2                                                              
##   err_obs_phi       0                                                                
##   err_proc_sigma    1                                                                
##   err_proc_phi      0                                                                
##   err_round         NA                                                               
##   sim_seed          NA                                                               
## Fitting time: 0.971 secs elapsed
## Parameters (10 dates)(* = fixed value):
##          date K600.daily      Pmax        alpha       ER20 err.obs.sigma err.obs.phi err.proc.sigma
## 1  2012-09-18        16* 8.499653* 0.010029735* -4.780125*          0.2           0              1 
## 2  2012-09-19        16* 7.007731* 0.010537178* -4.657027*          0.2           0              1 
## 3  2012-09-20        16* 3.238979* 0.009774623* -3.654986*          0.2           0              1 
## 4  2012-09-21        16* 6.647592* 0.011448446* -5.116775*          0.2           0              1 
## 5  2012-09-22        16* 7.267074* 0.011769600* -3.637974*          0.2           0              1 
## 6  2012-09-23        16* 7.610239* 0.011205473* -8.047155*          0.2           0              1 
## 7  2012-09-24        16* 8.687355* 0.008570020* -1.581533*          0.2           0              1 
## 8  2012-09-25        16* 6.872180* 0.010270915* -5.840345*          0.2           0              1 
## 9  2012-09-26        16* 5.671489* 0.009372155* -7.103388*          0.2           0              1 
## 10 2012-09-27        16* 8.824851* 0.011480065* -3.531540*          0.2           0              1 
##    err.proc.phi discharge.daily msgs.fit
## 1            0        24.90884        NA
## 2            0        22.77362        NA
## 3            0        20.05383        NA
## 4            0        20.18165        NA
## 5            0        22.60640        NA
## 6            0        20.94767        NA
## 7            0        22.26052        NA
## 8            0        17.88998        NA
## 9            0        18.15039        NA
## 10           0        19.49836        NA
## Predictions (10 dates):
##          date      GPP GPP.lower GPP.upper        ER ER.lower ER.upper msgs.fit msgs.pred
## 1  2012-09-18 3.322718        NA        NA -2.733984       NA       NA       NA          
## 2  2012-09-19 2.917873        NA        NA -2.714620       NA       NA       NA          
## 3  2012-09-20 1.495126        NA        NA -2.132107       NA       NA       NA          
## 4  2012-09-21 2.823602        NA        NA -2.997445       NA       NA       NA          
## 5  2012-09-22 3.032138        NA        NA -2.116472       NA       NA       NA          
## 6  2012-09-23 3.088538        NA        NA -4.810156       NA       NA       NA          
## 7  2012-09-24 3.063456        NA        NA -0.946805       NA       NA       NA          
## 8  2012-09-25 2.768727        NA        NA -3.188522       NA       NA       NA          
## 9  2012-09-26 2.326526        NA        NA -3.966624       NA       NA       NA          
## 10 2012-09-27 3.379752        NA        NA -1.901252       NA       NA       NA</code></pre>
<p>Sim models produce daily estimates of GPP and ER, which should help in choosing simulation parameters. The GPP and ER predictions have no error bars because they’re direct calculations from the daily parameters.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_metab_preds.html">plot_metab_preds</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
<div id="multi-day-simulations" class="section level1">
<h1 class="hasAnchor">
<a href="#multi-day-simulations" class="anchor"></a>Multi-Day Simulations</h1>
<p>You can also use <code>sim</code> models to simulate variation across many days. Let’s start by generating a 60-day timeseries of water temperature, DO.sat, etc. by concatenating 6 copies of 10 days of French Creek data:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_metab.html">data_metab</a></span><span class="op">(</span><span class="st">'10'</span>,<span class="st">'15'</span><span class="op">)</span>
<span class="va">datlen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">solar.time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html">as.difftime</a></span><span class="op">(</span><span class="fl">15</span>, units<span class="op">=</span><span class="st">'mins'</span><span class="op">)</span>, units<span class="op">=</span><span class="st">'days'</span><span class="op">)</span>
<span class="va">dat20</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">10</span>, <span class="kw">function</span><span class="op">(</span><span class="va">add</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">dat</span>, solar.time <span class="op">=</span> <span class="va">solar.time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html">as.difftime</a></span><span class="op">(</span><span class="va">add</span>, units<span class="op">=</span><span class="st">'days'</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>You can specify a distribution rather than specific values for GPP, ER, and/or K600 parameters. In fact, this is the default if you don’t specify daily data:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="fu"><a href="../reference/mm_name.html">mm_name</a></span><span class="op">(</span><span class="st">'sim'</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">sp</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'K600_daily'</span>,<span class="st">'GPP_daily'</span>,<span class="st">'ER_daily'</span><span class="op">)</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fun</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>code<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">fun</span>, <span class="st">'srcref'</span><span class="op">)</span>, example_vals<span class="op">=</span><span class="fu">fun</span><span class="op">(</span>n<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<pre><code>## $K600_daily
## $K600_daily$code
## NULL
## 
## $K600_daily$example_vals
##  [1] 11.394019  2.131146  2.065676  2.981063  0.293542  1.166151  0.000000  0.000000  0.000000
## [10]  1.078682
## 
## 
## $GPP_daily
## $GPP_daily$code
## NULL
## 
## $GPP_daily$example_vals
##  [1] 11.353710  4.155439  8.982939  5.629463 10.759050  5.470030  7.068656 16.924344  9.929368
## [10] 13.558922
## 
## 
## $ER_daily
## $ER_daily$code
## NULL
## 
## $ER_daily$example_vals
##  [1] -10.841892 -13.972932  -9.554105 -13.866939  -8.484028 -17.256354  -9.523367 -15.533992
##  [9]  -6.300450 -11.978812</code></pre>
<p>These functions get called to generate new values for K600.daily, GPP.daily, and ER.daily each time you call <code>get_params</code>, <code>predict_metab</code>, or <code>predict_DO</code>. (They’ll be the same random values each time if you set <code>sim_seed</code>.)</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="va">sp</span>, <span class="va">dat20</span>, data_daily<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>
<span class="fu"><a href="../reference/get_params.html">get_params</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'date'</span>,<span class="st">'K600.daily'</span>,<span class="st">'GPP.daily'</span>,<span class="st">'ER.daily'</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##          date K600.daily GPP.daily   ER.daily
## 1  2012-09-18  9.3774849  9.965002 -11.348430
## 2  2012-09-19  0.0000000  8.214422  -8.264543
## 3  2012-09-20  0.0000000  5.592685 -11.589683
## 4  2012-09-21  2.4941115 10.895283  -9.853461
## 5  2012-09-22  1.5609832 13.542714  -8.017449
## 6  2012-09-23  6.3209123  5.712464  -7.391169
## 7  2012-09-24  5.3781978  6.843066  -6.007423
## 8  2012-09-25  0.4188259  2.868695  -9.371331
## 9  2012-09-26  5.0576457  8.833299  -9.217404
## 10 2012-09-27  3.4673669  7.283434  -7.986230
## 11 2012-09-28  0.0000000 10.172453  -7.787978
## 12 2012-09-29  5.3578053  0.000000 -14.645748
## 13 2012-09-30  0.0000000  0.000000  -7.832416
## 14 2012-10-01  0.0000000  8.727776  -9.724398
## 15 2012-10-02  5.8449558 11.477985  -9.714946
## 16 2012-10-03  2.0577948  1.742424 -10.664851
## 17 2012-10-04  4.7878519  5.029605  -1.696152
## 18 2012-10-05  7.1718757  6.608512  -8.110131
## 19 2012-10-06  1.4934472  7.890415 -11.899357
## 20 2012-10-07  6.8116574  3.668817  -5.114960</code></pre>
<p>You can also set <code>err_obs_sigma</code> and other error terms as daily values and/or functions. The defaults are simple numeric values that get replicated to every date, but the values can also be vectors or functions, as with <code>GPP_daily</code>, etc.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="st">'sim'</span>, err_obs_sigma<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">...</span><span class="op">)</span> <span class="op">-</span><span class="fl">0.01</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">1</span>, err_proc_sigma<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.1</span>, <span class="fl">0.005</span><span class="op">)</span>, err_proc_phi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out<span class="op">=</span><span class="fl">20</span><span class="op">)</span>, GPP_daily<span class="op">=</span><span class="fl">3</span>, ER_daily<span class="op">=</span><span class="op">-</span><span class="fl">4</span>, K600_daily<span class="op">=</span><span class="fl">16</span><span class="op">)</span>
<span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="va">sp</span>, <span class="va">dat20</span><span class="op">)</span>
<span class="fu"><a href="../reference/get_params.html">get_params</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span></code></pre></div>
<pre><code>##          date K600.daily GPP.daily ER.daily err.obs.sigma err.obs.phi err.proc.sigma err.proc.phi
## 1  2012-09-18         16         3       -4          0.19           0     0.10006142   0.00000000
## 2  2012-09-19         16         3       -4          0.36           0     0.09579332   0.05263158
## 3  2012-09-20         16         3       -4          0.51           0     0.09896637   0.10526316
## 4  2012-09-21         16         3       -4          0.64           0     0.10211171   0.15789474
## 5  2012-09-22         16         3       -4          0.75           0     0.09886735   0.21052632
## 6  2012-09-23         16         3       -4          0.84           0     0.09111399   0.26315789
## 7  2012-09-24         16         3       -4          0.91           0     0.09789418   0.31578947
## 8  2012-09-25         16         3       -4          0.96           0     0.09981824   0.36842105
## 9  2012-09-26         16         3       -4          0.99           0     0.10008518   0.42105263
## 10 2012-09-27         16         3       -4          1.00           0     0.09949634   0.47368421
## 11 2012-09-28         16         3       -4          0.99           0     0.10479603   0.52631579
## 12 2012-09-29         16         3       -4          0.96           0     0.09311189   0.57894737
## 13 2012-09-30         16         3       -4          0.91           0     0.09617960   0.63157895
## 14 2012-10-01         16         3       -4          0.84           0     0.09927530   0.68421053
## 15 2012-10-02         16         3       -4          0.75           0     0.10010262   0.73684211
## 16 2012-10-03         16         3       -4          0.64           0     0.09815024   0.78947368
## 17 2012-10-04         16         3       -4          0.51           0     0.10386788   0.84210526
## 18 2012-10-05         16         3       -4          0.36           0     0.09691962   0.89473684
## 19 2012-10-06         16         3       -4          0.19           0     0.10307404   0.94736842
## 20 2012-10-07         16         3       -4          0.00           0     0.09703766   1.00000000
##    discharge.daily
## 1        19.094945
## 2        17.152854
## 3        18.462010
## 4        23.432169
## 5        16.781991
## 6        16.082583
## 7        12.833561
## 8        24.158921
## 9        18.873719
## 10       16.855542
## 11       17.669455
## 12       20.502169
## 13       22.095738
## 14       23.020073
## 15       17.409789
## 16       19.495505
## 17       17.483742
## 18        9.117643
## 19       19.294179
## 20       23.883561</code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_DO_preds.html">plot_DO_preds</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-21-1.png" width="700"> The above simulation emphasized day-to-day variation in <code>err_obs_sigma</code>. Here’s a simulation emphasizing variation in <code>err_proc_sigma</code> and <code>err_proc_phi</code>:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="st">'sim'</span>, err_obs_sigma<span class="op">=</span><span class="fl">0.01</span>, err_proc_sigma<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">4</span><span class="op">)</span>, each<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, err_proc_phi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.8</span>, length.out<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, times<span class="op">=</span><span class="fl">2</span><span class="op">)</span>, GPP_daily<span class="op">=</span><span class="fl">3</span>, ER_daily<span class="op">=</span><span class="op">-</span><span class="fl">4</span>, K600_daily<span class="op">=</span><span class="fl">16</span><span class="op">)</span>
<span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="va">sp</span>, <span class="va">dat20</span><span class="op">)</span>
<span class="fu"><a href="../reference/get_params.html">get_params</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span></code></pre></div>
<pre><code>##          date K600.daily GPP.daily ER.daily err.obs.sigma err.obs.phi err.proc.sigma err.proc.phi
## 1  2012-09-18         16         3       -4          0.01           0            0.5   0.00000000
## 2  2012-09-19         16         3       -4          0.01           0            0.5   0.08888889
## 3  2012-09-20         16         3       -4          0.01           0            0.5   0.17777778
## 4  2012-09-21         16         3       -4          0.01           0            0.5   0.26666667
## 5  2012-09-22         16         3       -4          0.01           0            0.5   0.35555556
## 6  2012-09-23         16         3       -4          0.01           0            0.5   0.44444444
## 7  2012-09-24         16         3       -4          0.01           0            0.5   0.53333333
## 8  2012-09-25         16         3       -4          0.01           0            0.5   0.62222222
## 9  2012-09-26         16         3       -4          0.01           0            0.5   0.71111111
## 10 2012-09-27         16         3       -4          0.01           0            0.5   0.80000000
## 11 2012-09-28         16         3       -4          0.01           0            4.0   0.00000000
## 12 2012-09-29         16         3       -4          0.01           0            4.0   0.08888889
## 13 2012-09-30         16         3       -4          0.01           0            4.0   0.17777778
## 14 2012-10-01         16         3       -4          0.01           0            4.0   0.26666667
## 15 2012-10-02         16         3       -4          0.01           0            4.0   0.35555556
## 16 2012-10-03         16         3       -4          0.01           0            4.0   0.44444444
## 17 2012-10-04         16         3       -4          0.01           0            4.0   0.53333333
## 18 2012-10-05         16         3       -4          0.01           0            4.0   0.62222222
## 19 2012-10-06         16         3       -4          0.01           0            4.0   0.71111111
## 20 2012-10-07         16         3       -4          0.01           0            4.0   0.80000000
##    discharge.daily
## 1         19.78310
## 2         16.51499
## 3         19.78667
## 4         24.94463
## 5         15.43331
## 6         18.89366
## 7         16.53895
## 8         16.43017
## 9         21.30483
## 10        18.93355
## 11        18.66546
## 12        18.89783
## 13        22.11005
## 14        21.44448
## 15        17.18484
## 16        21.39467
## 17        19.68361
## 18        15.96506
## 19        20.88555
## 20        20.82709</code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_DO_preds.html">plot_DO_preds</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-22-1.png" width="700"> The daily parameter functions that you assign in <code><a href="../reference/specs.html">specs()</a></code> can refer to previous daily parameters in the list. For example, ER_daily can be a function of <code>GPP.daily</code>. Values of <code>GPP.daily</code> may have been specified in the <code>GPP.daily</code> column of <code>data_daily</code> or in the <code>GPP_daily</code> argument to <code><a href="../reference/specs.html">specs()</a></code>; the ER function should refer to it with its period-separated name, <code>GPP.daily</code>.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="st">'sim'</span>, err_obs_sigma<span class="op">=</span><span class="fl">0.01</span>, err_proc_sigma<span class="op">=</span><span class="fl">0.4</span>, K600_daily<span class="op">=</span><span class="fl">16</span>, GPP_daily<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, ER_daily<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">GPP.daily</span>, <span class="va">...</span><span class="op">)</span> <span class="va">GPP.daily</span><span class="op">*</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span>
<span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="va">sp</span>, <span class="va">dat20</span><span class="op">)</span>
<span class="fu"><a href="../reference/get_params.html">get_params</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span></code></pre></div>
<pre><code>##          date K600.daily GPP.daily ER.daily err.obs.sigma err.obs.phi err.proc.sigma err.proc.phi
## 1  2012-09-18         16       3.8     -7.6          0.01           0            0.4            0
## 2  2012-09-19         16       4.4     -8.8          0.01           0            0.4            0
## 3  2012-09-20         16       4.3     -8.6          0.01           0            0.4            0
## 4  2012-09-21         16       3.4     -6.8          0.01           0            0.4            0
## 5  2012-09-22         16       5.2    -10.4          0.01           0            0.4            0
## 6  2012-09-23         16       4.7     -9.4          0.01           0            0.4            0
## 7  2012-09-24         16       5.2    -10.4          0.01           0            0.4            0
## 8  2012-09-25         16       5.2    -10.4          0.01           0            0.4            0
## 9  2012-09-26         16       5.5    -11.0          0.01           0            0.4            0
## 10 2012-09-27         16       4.3     -8.6          0.01           0            0.4            0
## 11 2012-09-28         16       3.3     -6.6          0.01           0            0.4            0
## 12 2012-09-29         16       2.9     -5.8          0.01           0            0.4            0
## 13 2012-09-30         16       1.4     -2.8          0.01           0            0.4            0
## 14 2012-10-01         16       4.9     -9.8          0.01           0            0.4            0
## 15 2012-10-02         16       4.3     -8.6          0.01           0            0.4            0
## 16 2012-10-03         16       4.4     -8.8          0.01           0            0.4            0
## 17 2012-10-04         16       4.8     -9.6          0.01           0            0.4            0
## 18 2012-10-05         16       4.0     -8.0          0.01           0            0.4            0
## 19 2012-10-06         16       3.1     -6.2          0.01           0            0.4            0
## 20 2012-10-07         16       1.6     -3.2          0.01           0            0.4            0
##    discharge.daily
## 1         18.88479
## 2         21.13845
## 3         21.47058
## 4         17.24911
## 5         20.12178
## 6         21.91174
## 7         19.23959
## 8         21.04799
## 9         22.55928
## 10        21.55456
## 11        18.13283
## 12        18.17106
## 13        16.73818
## 14        17.32116
## 15        18.42143
## 16        18.32363
## 17        21.23007
## 18        19.10121
## 19        20.18124
## 20        16.59524</code></pre>
<p>The K600_daily function can also take advantage of pre-specified model structures relating K to discharge. As of December 2016, the <code>Kb</code> formulation (<code>pool_K600 = 'binned'</code>) is the only one available. But it’s a good one! See which parameters you can set by calling <code>specs</code> one preliminary time with a Kb model name:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specs.html">specs</a></span><span class="op">(</span><span class="fu"><a href="../reference/mm_name.html">mm_name</a></span><span class="op">(</span><span class="st">'sim'</span>, pool_K600<span class="op">=</span><span class="st">'binned'</span>, ER_fun<span class="op">=</span><span class="st">'q10temp'</span><span class="op">)</span>, sim_seed<span class="op">=</span><span class="fl">6332</span><span class="op">)</span></code></pre></div>
<p>The new and relevant arguments are <code>K600_lnQ_nodes_centers</code>, <code>K600_lnQ_cnode_meanlog</code>, <code>K600_lnQ_cnode_sdlog</code>, <code>K600_lnQ_nodediffs_meanlog</code>, <code>K600_lnQ_nodediffs_sdlog</code>, and <code>lnK600_lnQ_nodes</code>. The defaults might work just fine for you, and changing <code>lnK600_lnQ_nodes</code> is especially non-recommended. It’s probably useful to dial down the noise relating K600.daily to lnK600_lnQ_nodes:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metab.html">metab</a></span><span class="op">(</span><span class="fu"><a href="../reference/revise.html">revise</a></span><span class="op">(</span><span class="va">sp</span>, K600_daily<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">K600_daily_predlog</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">K600_daily_predlog</span><span class="op">)</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="va">dat20</span><span class="op">)</span>
<span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_params.html">get_params</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span>
<span class="va">pars</span></code></pre></div>
<pre><code>##          date discharge.daily K600.daily GPP.daily       ER20 err.obs.sigma err.obs.phi
## 1  2012-09-18        17.95254   3.276343 10.861268  -4.839845          0.01           0
## 2  2012-09-19        19.74833   4.258166  4.278131  -4.599670          0.01           0
## 3  2012-09-20        24.11093   6.660064  4.872679  -5.062334          0.01           0
## 4  2012-09-21        19.23720   2.995546 10.715018  -6.466619          0.01           0
## 5  2012-09-22        21.83327   5.494783  3.220689  -7.685111          0.01           0
## 6  2012-09-23        18.66778   3.104385  9.406120 -12.425723          0.01           0
## 7  2012-09-24        21.66651   5.629606  7.829844 -13.288060          0.01           0
## 8  2012-09-25        23.27941   4.914728 12.902530  -5.806561          0.01           0
## 9  2012-09-26        18.18747   3.135139  1.363060 -10.178470          0.01           0
## 10 2012-09-27        22.76868   5.704705  4.159898  -7.718060          0.01           0
## 11 2012-09-28        19.56126   3.960659  8.879820  -6.513834          0.01           0
## 12 2012-09-29        20.50053   4.006042 10.583638  -4.917149          0.01           0
## 13 2012-09-30        17.56558   2.382708  1.277344  -7.584540          0.01           0
## 14 2012-10-01        23.58988   6.083747  6.481855 -12.646758          0.01           0
## 15 2012-10-02        20.66988   4.140573  4.473403 -10.472093          0.01           0
## 16 2012-10-03        22.45883   5.352439  9.705709 -15.281010          0.01           0
## 17 2012-10-04        24.31525   6.654290  3.102061  -5.419053          0.01           0
## 18 2012-10-05        20.59640   4.464318  1.188528  -8.078135          0.01           0
## 19 2012-10-06        22.09928   5.644090  9.026385  -9.683760          0.01           0
## 20 2012-10-07        23.84877   6.174243  7.358561  -8.962819          0.01           0
##    err.proc.sigma err.proc.phi
## 1             0.2            0
## 2             0.2            0
## 3             0.2            0
## 4             0.2            0
## 5             0.2            0
## 6             0.2            0
## 7             0.2            0
## 8             0.2            0
## 9             0.2            0
## 10            0.2            0
## 11            0.2            0
## 12            0.2            0
## 13            0.2            0
## 14            0.2            0
## 15            0.2            0
## 16            0.2            0
## 17            0.2            0
## 18            0.2            0
## 19            0.2            0
## 20            0.2            0</code></pre>
<p>In this model, even the K~Q relationship is simulated on each call to <code>get_params</code>, <code>predict_metab</code>, or <code>predict_DO</code>. You can inspect the relationship by looking at the <code>K600_eqn</code> attribute to the output of <code>get_params</code>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">pars</span>, <span class="st">'K600_eqn'</span><span class="op">)</span></code></pre></div>
<pre><code>## $K600_lnQ_nodes_centers
## [1] 2.7 2.9 3.1 3.3
## 
## $K600_lnQ_cnode_meanlog
##  [1] 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759
## [11] 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759 1.791759
## 
## $K600_lnQ_cnode_sdlog
##  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## 
## $K600_lnQ_nodediffs_meanlog
##  [1] 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2
## 
## $K600_lnQ_nodediffs_sdlog
##  [1] 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5
## 
## $lnK600_lnQ_nodes
## [1] 0.4988654 1.1196713 1.7336039 1.9001201
## 
## $K600_daily_predlog
##  [1] 1.081589 1.374665 1.802429 1.294170 1.682755 1.201935 1.659220 1.773209 1.121921 1.754740
## [11] 1.345448 1.489414 1.013952 1.784239 1.514669 1.743331 1.809455 1.503737 1.719929 1.793327</code></pre>
<p>The centers and nodes are the essential pieces of the final piecewise relationship (blue points and line). We can also identify the predictions for specific dates and discharges along that line (purple points) and the K600 params that result from adding noise to those predictions (red points):</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">KQ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">pars</span>, <span class="st">'K600_eqn'</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'K600_lnQ_nodes_centers'</span>, <span class="st">'lnK600_lnQ_nodes'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">Kpred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pars</span>, <span class="va">date</span>, <span class="va">discharge.daily</span>, <span class="va">K600.daily</span><span class="op">)</span>, K600_daily_predlog<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">pars</span>, <span class="st">'K600_eqn'</span><span class="op">)</span><span class="op">$</span><span class="va">K600_daily_predlog</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">KQ</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">K600_lnQ_nodes_centers</span>, y<span class="op">=</span><span class="va">lnK600_lnQ_nodes</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">'blue'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">'blue'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">Kpred</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">discharge.daily</span><span class="op">)</span>, y<span class="op">=</span><span class="va">K600_daily_predlog</span><span class="op">)</span>, color<span class="op">=</span><span class="st">'purple'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">Kpred</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">discharge.daily</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">K600.daily</span><span class="op">)</span><span class="op">)</span>, color<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></code></pre></div>
<p><img src="simulations_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<p>```</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Alison P. Appling, Robert O. Hall, Maite Arroita, Charles B. Yackulic.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
