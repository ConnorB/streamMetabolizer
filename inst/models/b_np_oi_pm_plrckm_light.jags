# b_np_oi_pm_km.jags

data {
  for(i in 1:(n-1)) {
    # Coefficients by pairmeans (e.g., mean(frac_GPP[i:(i+1)]) applies to the DO step from i to i+1)
    coef_light[1:d,i]  <- (frac_GPP[1:d,i] + frac_GPP[1:d,i+1])/2.0;
    coef_depth[1:d,i]  <- (depth[1:d,i] + depth[1:d,i+1])/2.0;
    coef_ER[1:d,i]   <- (frac_ER[1:d,i] + frac_ER[1:d,i+1])/2.0 / ((depth[1:d,i] + depth[1:d,i+1])/2.0)
    coef_K600_part[1:d,i] <- (KO2_conv[1:d,i] + KO2_conv[1:d,i+1])/2.0 * (frac_D[1:d,i] + frac_D[1:d,i+1])/2.0
    DO_sat_pairmean[1:d,i] <- (DO_sat[1:d,i] + DO_sat[1:d,i+1])/2.0
  }
}

model {

  for(j in 1:d) {
    for(i in 1:(n-1)) {
      mult_coef_GPP[j,i] <- mult_GPP[j,i] * coef_light[j,i];
    }
    for(i in 1:(n-1)) {
      coef_GPP[j,i] <- (mult_coef_GPP[j,i] / sum(mult_coef_GPP[j,])) / coef_depth[j,i];
    }
  }

  # Model DO time series
  # * pairmeans version
  # * observation error
  # * no process error
  # * reaeration depends on DO_mod
  
  # DO model
  DO_mod[1:d,1] <- DO_obs_1
  for(i in 1:(n-1)) {
    DO_mod[1:d,i+1] <- (
      DO_mod[1:d,i] +
      GPP_daily * coef_GPP[1:d,i] +
      ER_daily * coef_ER[1:d,i] +
      K600_daily * coef_K600_part[1:d,i] * (DO_sat_pairmean[1:d,i] - DO_mod[1:d,i]/2.0)
    ) / (1.0 + K600_daily * coef_K600_part[1:d,i] / 2.0)
  }

  # Independent, identically distributed observation error
  for(i in 1:n) {
    for(j in 1:d) {
      DO_obs[j,i] ~ dnorm(DO_mod[j,i], pow(err_obs_iid_sigma, -2))
    }
  }
  # SD (sigma) of the observation errors
  err_obs_iid_sigma ~ dgamma(err_obs_iid_sigma_shape, err_obs_iid_sigma_rate)
  
  # Light multiplier to capture error in the GPP rate
  for(i in 1:(n-1)) {
    for(j in 1:d) {
      mult_GPP[j,i] ~ dlnorm(0, 1); #mult_GPP_sigma
    }
  }
  # SD (sigma) of the light multiplier
  #mult_GPP_sigma ~ gamma(1, 0.1);
  
  
  # Daily metabolism priors
  for(j in 1:d) {
    GPP_daily[j] ~ dnorm(GPP_daily_mu, pow(GPP_daily_sigma, -2))
    ER_daily[j] ~ dnorm(ER_daily_mu, pow(ER_daily_sigma, -2))
    K600_daily[j] ~ dnorm(K600_daily_mu, pow(K600_daily_sigma, -2))
  }
}
